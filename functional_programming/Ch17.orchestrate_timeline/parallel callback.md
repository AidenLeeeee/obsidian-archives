## 병렬 콜백

여러 비동기 요청에 대한 응답을 모두 기다렸다가 특정 작업을 수행하여야 하는 상황이 있을 수 있다.
한 작업이 끝났더라도, 나머지 작업들이 끝나지 않은 상태에서 콜백을 수행하면 잘못된 결과가 나오는 상황이다.
하지만 비동기 요청에 대한 응답은 서버 혹은 네트워크 상황에 따라 그 응답 시간이 제각기 다르기 때문에 언제 모든 응답이 도착하는지 예상하기 어렵다.

바로 위와 같은 경우에 **컷(Cut)** 을 활용할 수 있다.
컷은 순서를 보장해주는 역할을 한다.
다시 말해, 모든 응답이 처리되고 나서 마지막으로 콜백을 수행할 수 있도록 도와주는 셈이다.
결국 모든 콜백은 서로가 종료되기를 기다릴 수 있다.

컷을 만들면 타임라인을 앞부분과 뒷부분으로 나눌 수 있다.
그래서 컷 앞에 있는 타임라인과 뒤에 있는 타임라인을 따로 분석할 수 있다.
컷의 앞부분과 뒷부분에 있는 액션은 서로 섞이지 않는다.
컷은 실행 가능한 순서를 줄이기 때문에 애플리케이션의 복잡성을 줄여준다.

### 컷(Cut) 구현하기

자바스크립트는 단일 스레드 언어이기 때문에 이 장점을 활용하여 간단하게 동시성 기본형을 구현할 수 있다.
아래의 컷 함수는 어떤 타임라인 작업이 끝났을 때 호출될 것이고, 호출될 때마다 호출된 횟수를 증가시킨다.
그리고 마지막 타임라인이 함수를 호출했을 때 콜백을 부른다.

```javascript
function Cut(num, callback) {
	let num_finished = 0;
	return function() {
		num_finished += 1;
		if (num_finished === num) callback();
	};
}
```

- `num` : 기다릴 타임라인의 수
- `callback` : 모든 것이 끝났을 때 호출될 콜백

위 `Cut()` 함수가 리턴하는 함수는 각각의 타임라인이 끝났을 때 호출하는 함수이다.
따라서 자유변수(Free variable)인 `num_finished` 를 계속해서 증가시키다가, 지정된 수의 모든 타임라인이 종료되면, 마지막으로 callback 을 호출하게 된다.

아래는 `Cut()` 을 사용하는 간단한 예제이다.

```javascript
const done = Cut(3, function() {
	console.log("3 timelines are finished!");
});

done();
done();
done();

// console -> "3 timelines are finished!"
```

세 번째 `done()` 이 호출되면 콘솔에 메시지를 출려