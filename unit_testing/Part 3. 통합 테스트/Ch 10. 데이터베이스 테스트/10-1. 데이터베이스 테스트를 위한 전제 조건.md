
통합 테스트라는 퍼즐의 마지막 조각은 프로세스 외부 관리 의존성이다. 가장 일반적인 예는 애플리케이션 데이터베이스다. 애플리케이션 데이터베이스는 다른 애플리케이션이 접근할 수 없는 데이터베이스다.

### 데이터베이스를 형상 관리 시스템에 유지

데이터베이스를 테스트하는 방법의 첫 번째 단계는 데이터베이스 스키마를 일반 코드로 취급하는 것이다. 일반 코드와 마찬가지로 데이터베이스 스키마는 Git과 같은 형상 관리 시스템에 저장하는 것이 최선이다.

모델 데이터베이스를 사용할 수도 있지만, 이는 데이터베이스 스키마를 유지하는 데 상당히 좋지 않은 방법이다.
이유는 아래와 같다.
- 변경 내역 부재: 데이터베이스 스키마를 과거의 특정 시점으로 되돌릴 수 없다. 이는 운영 환경에서 버그를 재현할 때 중요할 수 있다.
- 복수의 원천 정보: 모델 데이터베이스는 개발 상태에 대한 원천 정보를 둘러싸고 경합하게 된다. 이렇게 기준을 두 가지(Git, 모델 데이터베이스)로 두면 부담이 가중된다.

반면 모든 데이터베이스 스키마 업데이트를 형상 관리 시스템에 두면 원천 정보를 하나로 할 수 있고, 일반 코드 변경과 함께 데이터베이스 변경을 추적할 수 있다. 형상 관리 외부에서는 데이터베이스 구조를 수정하면 안 된다.

### 참조 데이터도 데이터베이스 스키마다.

데이터베이스 스키마에 관해 유력한 용의자는 테이블, 뷰, 인덱스, 저장 프로시저 그리고 데이터베이스가 어떻게 구성되는지에 대한 청사진을 형성하는 나머지 모든 것이다. 스키마는 SQL 스크립트 형태로 표현된다. 개발 중에 언제든지 이러한 스크립트로 기능을 완전히 갖춘 최신 데이터베이스 인스턴스를 만들 수 있어야 한다.
그러나 데이터베이스 스키마에 속하지만, 데이터베이스 스키마로 거의 여기지 않는 부분이 있다. 바로 참조 데이터다.

참조 데이터는 애플리케이션이 제대로 작동하도록 미리 채워야 하는 데이터이다.
애플리케이션이 데이터를 수정할 수 있으면 일반 데이터이고, 그렇지 않으면 참조 데이터이다.

이러한 참조 데이터도 애플리케이션의 필수 사항이므로, 테이블, 뷰 그리고 다른 데이터베이스 스키마와 함께 SQL INSERT 문 형태로 형상 관리 시스템에 저장해야 한다.

### 모든 개발자를 위한 별도의 데이터베이스 인스턴스

실제 데이터베이스로 테스트하는 것은 충분히 어렵다. 다른 개발자들과 데이터베이스를 공유해야 한다면 훨씬 더 어려워진다. 공유 데이터베이스를 사용하면 개발 프로세스를 방해하게 된다.
- 서로 다른 개발자가 실행한 테스트는 서로 간섭되기 때문이다.
- 하위 호환성이 없는 변경으로 다른 개발자의 작업을 막을 수 있기 때문이다.

테스트 실행 속도를 극대화하려면 개발자마다 별도로 데이터베이스 인스턴스를 사용하라.

### 상태 기반 데이터베이스 배포와 마이그레이션 기반 데이터베이스 배포

1. **상태 기반 방식**
	상태 기반 데이터베이스 배포 방식은 개발 내내 유지 보수하는 모델 데이터베이스를 활용한다. 따라서 배포 중에 비교 도구가 스크립트를 생성해 운영 데이터베이스를 모델 데이터베이스와 비교해 최신 상태로 유지한다.
	차이점은 상태 기반 방식을 사용하면 물리적인 모델 데이터베이스는 원천 데이터가 아니라는 것이다. 대신 해당 데이터베이스를 작성하는 데 사용할 수 있는 SQL 스크립트가 있으며, 이는 형상 관리 시스템에 저장된다.

	이 방식에서는 비교 도구가 모든 어려운 작업을 수행한다. 운영 데이터베이스의 상태와 관계없이, 비교 도구는 불필요한 테이블이나 컬럼을 삭제하고 바꾸는 등 동기화에 필요한 모든 작업을 수행한다.

2. **마이그레이션 기반 방식**
	반면 마이그레이션 기반 방식은 데이터베이스를 어떤 버전에서 다른 버전으로 전환하는 명시적인 마이그레이션을 의미한다. 이 방식은 운영 데이터베이스와 개발 데이터베이스를 자동으로 동기화하기 위한 비교 도구를 쓸 수 없고, 업그레이드 스크립트를 직접 작성해야 한다.

	이 방식에서 형상 관리 시스템에 저장되는 산출물은 데이터베이스 상태가 아닌 마이그레이션이다. 마이그레이션은 일반적으로 평이한 SQL 스크립트로 표시한다.

두 방식의 차이점은 아래와 같다.
- 상태 기반 방식은 상태를 형상 관리에 저장함으로써 상태를 명시하고 비교 도구가 마이그레이션을 암묵적으로 제어할 수 있게 한다.
- 마이그레이션 기반 방식은 마이그레이션을 명시적으로 하지만 상태를 암묵적으로 둔다. 데이터베이스 상태를 직접 볼 수 없으며 마이그레이션으로 조합해야 한다.

데이터베이스 상태가 명확하면 병합 충돌을 처리하기가 수월한 반면, 명시적 마이그레이션은 데이터 모션(data motion) 문제를 해결하는 데 도움이 된다.
- **데이터 모션(data motion)**: 새로운 데이터베이스 스키마를 준수하도록 기존 데이터의 형태를 변경하는 과정이다.

정리하면, 이미 릴리스되어 운영 중인 대부분의 엔터프라이즈 애플리케이션에서는 병합 충돌 완화보다 데이터 모션이 더욱 중요하기 때문에 마이그레이션 기반 방식을 사용하는 것이 유리하다.